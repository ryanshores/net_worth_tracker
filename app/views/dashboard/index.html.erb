<h1 class="text-2xl font-bold mb-4">Net Worth Tracker</h1>

<button
  id="link-button"
  class="px-4 py-2 bg-blue-600 text-white rounded"
>
  Add account
</button>

<ul class="mt-6">
  <% @institutions.each do |inst| %>
    <li class="mb-2">
      <%= inst.name %>
      <% if inst.needs_auth? %>
        <span class="text-red-600">(needs reauth)</span>
      <% end %>
    </li>
  <% end %>
</ul>

<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
    function csrfHeaders(extra = {}) {
        const token = document.querySelector('meta[name="csrf-token"]')?.content;
        return { "X-CSRF-Token": token, ...extra };
    }

    document.getElementById("link-button").onclick = async () => {
        const headers = csrfHeaders({ "Content-Type": "application/json", "Accept": "application/json" })
        const res = await fetch("/plaid/link_token", { method: "POST", headers: headers })
        const data = await res.json()

        const handler = Plaid.create({
            token: data.link_token,
            onSuccess: async (public_token, metadata) => {
                await fetch("/plaid/exchange_token", {
                    method: "POST",
                    headers: headers,
                    credentials: "same-origin",
                    body: JSON.stringify({
                        public_token: public_token,
                        institution_name: metadata.institution.name
                    })
                })

                window.location.reload()
            }
        })

        handler.open()
    }
</script>